name: PR Preview Deployment (Azure)

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

env:
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  LOCATION: westeurope

jobs:
  deploy:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Generate app name
        id: app-name
        run: |
          # Generate unique app name based on PR number
          APP_NAME="speakstorelocate-pr-${{ github.event.pull_request.number }}"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "App name: $APP_NAME"

      - name: Setup Azure Container Registry
        id: setup-acr
        run: |
          RG="${{ env.RESOURCE_GROUP }}"
          
          # Get or create ACR with fixed name
          ACR_NAME="speakstorelocateacr"
          if ! az acr show --name $ACR_NAME --resource-group $RG 2>/dev/null; then
            echo "Creating Azure Container Registry: $ACR_NAME"
            az acr create \
              --resource-group $RG \
              --name $ACR_NAME \
              --sku Basic \
              --location ${{ env.LOCATION }}
          fi
          
          ACR_LOGIN_SERVER=$(az acr show --name $ACR_NAME --resource-group $RG --query loginServer -o tsv)
          echo "acr_name=$ACR_NAME" >> $GITHUB_OUTPUT
          echo "acr_login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build-image
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"
          ACR_NAME="${{ steps.setup-acr.outputs.acr_name }}"
          ACR_LOGIN_SERVER="${{ steps.setup-acr.outputs.acr_login_server }}"
          
          # Login to ACR
          az acr login --name $ACR_NAME
          
          # Build and push
          IMAGE_NAME="$ACR_LOGIN_SERVER/$APP_NAME:${{ github.sha }}"
          docker build -f SpeakStoreLocate.ApiService/dockerfile -t $IMAGE_NAME .
          docker push $IMAGE_NAME
          
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Create or update Container App
        id: deploy
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"
          RG="${{ env.RESOURCE_GROUP }}"
          LOCATION="${{ env.LOCATION }}"
          IMAGE_NAME="${{ steps.build-image.outputs.image_name }}"
          
          # Check if Container App Environment exists, create if not
          ENV_NAME="speakstorelocate-env"
          if ! az containerapp env show --name $ENV_NAME --resource-group $RG 2>/dev/null; then
            echo "Creating Container App Environment: $ENV_NAME"
            az containerapp env create \
              --name $ENV_NAME \
              --resource-group $RG \
              --location $LOCATION
          fi
          
          # Check if Container App exists
          if az containerapp show --name $APP_NAME --resource-group $RG 2>/dev/null; then
            echo "Updating existing Container App: $APP_NAME"
            az containerapp update \
              --name $APP_NAME \
              --resource-group $RG \
              --image $IMAGE_NAME \
              --set-env-vars ASPNETCORE_ENVIRONMENT=Staging
          else
            echo "Creating new Container App: $APP_NAME"
            az containerapp create \
              --name $APP_NAME \
              --resource-group $RG \
              --environment $ENV_NAME \
              --image $IMAGE_NAME \
              --target-port 8080 \
              --ingress external \
              --env-vars ASPNETCORE_ENVIRONMENT=Staging \
              --min-replicas 0 \
              --max-replicas 1
          fi

      - name: Get deployment URL
        id: deployment-url
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"
          RG="${{ env.RESOURCE_GROUP }}"
          
          FQDN=$(az containerapp show \
            --name $APP_NAME \
            --resource-group $RG \
            --query properties.configuration.ingress.fqdn \
            -o tsv)
          
          URL="https://$FQDN"
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $URL"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const url = '${{ steps.deployment-url.outputs.url }}';
            const appName = '${{ steps.app-name.outputs.app_name }}';
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview-Umgebung')
            );
            
            const commentBody = `## üöÄ Preview-Umgebung bereitgestellt
            
            Ihre Preview-Umgebung ist bereit!
            
            - **URL**: ${url}
            - **App-Name**: \`${appName}\`
            - **Status**: ‚úÖ Bereitgestellt
            
            Die Preview-Umgebung wird automatisch gel√∂scht, wenn dieser PR geschlossen oder gemergt wird.
            
            ---
            *Bereitgestellt via Azure Container Apps ‚Ä¢ Aktualisiert: ${new Date().toISOString()}*`;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

  cleanup:
    name: Cleanup PR Preview
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    permissions:
      pull-requests: write
      id-token: write
    
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Generate app name
        id: app-name
        run: |
          APP_NAME="speakstorelocate-pr-${{ github.event.pull_request.number }}"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "App name to delete: $APP_NAME"

      - name: Delete Container App
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"
          RG="${{ env.RESOURCE_GROUP }}"
          
          az containerapp delete \
            --name $APP_NAME \
            --resource-group $RG \
            --yes || echo "App does not exist or already deleted"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const appName = '${{ steps.app-name.outputs.app_name }}';
            
            const commentBody = `## üßπ Preview-Umgebung bereinigt
            
            Die Preview-Umgebung wurde gel√∂scht.
            
            - **App-Name**: \`${appName}\`
            - **Status**: ‚ùå Gel√∂scht
            
            ---
            *Bereinigt via Azure Container Apps ‚Ä¢ ${new Date().toISOString()}*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
