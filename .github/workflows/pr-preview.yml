name: PR Preview Deployment (Azure)

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

env:
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  LOCATION: germanywestcentral
  ACR_NAME: speakstorelocateacr

jobs:
  deploy:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-id: ${{ secrets.AZURE_CLIENT_ID }}

      - name: Generate app name
        id: app-name
        run: |
          APP_NAME="speakstorelocate-pr-${{ github.event.pull_request.number }}"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

      - name: Resolve ACR login server
        id: acr
        run: |
          ACR_LOGIN_SERVER=$(az acr show \
            --name $ACR_NAME \
            --resource-group $RESOURCE_GROUP \
            --query loginServer -o tsv)
          echo "login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build-image
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"
          LOGIN_SERVER="${{ steps.acr.outputs.login_server }}"
          IMAGE_NAME="$LOGIN_SERVER/$APP_NAME:${{ github.sha }}"

          az acr login --name $ACR_NAME
          docker build -f SpeakStoreLocate.ApiService/dockerfile -t $IMAGE_NAME .
          docker push $IMAGE_NAME

          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Create or update Container App
        run: |
          APP_NAME="${{ steps.app-name.outputs.app_name }}"
          IMAGE_NAME="${{ steps.build-image.outputs.image_name }}"
          ENV_NAME="speakstorelocate-env"

          if ! az containerapp env show -n $ENV_NAME -g $RESOURCE_GROUP 2>/dev/null; then
            az containerapp env create \
              -n $ENV_NAME \
              -g $RESOURCE_GROUP \
              -l $LOCATION
          fi

          if az containerapp show -n $APP_NAME -g $RESOURCE_GROUP 2>/dev/null; then
            az containerapp update \
              -n $APP_NAME \
              -g $RESOURCE_GROUP \
              --image $IMAGE_NAME \
              --set-env-vars ASPNETCORE_ENVIRONMENT=Staging
          else
            az containerapp create \
              -n $APP_NAME \
              -g $RESOURCE_GROUP \
              --environment $ENV_NAME \
              --image $IMAGE_NAME \
              --target-port 8080 \
              --ingress external \
              --env-vars ASPNETCORE_ENVIRONMENT=Staging \
              --min-replicas 0 \
              --max-replicas 1
          fi

      - name: Get deployment URL
        id: deployment-url
        run: |
          FQDN=$(az containerapp show \
            -n "${{ steps.app-name.outputs.app_name }}" \
            -g $RESOURCE_GROUP \
            --query properties.configuration.ingress.fqdn -o tsv)
          echo "url=https://$FQDN" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            const url = '${{ steps.deployment-url.outputs.url }}';
            const app = '${{ steps.app-name.outputs.app_name }}';

            const body = `## ðŸš€ Preview-Umgebung bereitgestellt

- **URL**: ${url}
- **App**: \`${app}\`

Wird automatisch gelÃ¶scht, wenn der PR geschlossen wird.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body
            });

  cleanup:
    name: Cleanup PR Preview
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    permissions:
      pull-requests: write
      id-token: write

    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v1
        with:
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-id: ${{ secrets.AZURE_CLIENT_ID }}

      - name: Delete Container App
        run: |
          APP_NAME="speakstorelocate-pr-${{ github.event.pull_request.number }}"
          az containerapp delete -n $APP_NAME -g $RESOURCE_GROUP --yes || true

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: '## ðŸ§¹ Preview-Umgebung bereinigt\nDie Preview-App wurde gelÃ¶scht.'
            });
