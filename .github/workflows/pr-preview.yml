name: PR Preview Deployment (Azure)

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

env:
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  LOCATION: germanywestcentral
  ACR_NAME: speakstorelocate
  # Support both secrets and variables for ACR_PULL_IDENTITY_RESOURCE_ID
  # Prefer secrets if set, fall back to variables
  ACR_PULL_IDENTITY_RESOURCE_ID: ${{ secrets.AZURE_ACR_PULL_IDENTITY_RESOURCE_ID || vars.AZURE_ACR_PULL_IDENTITY_RESOURCE_ID }}

jobs:
  deploy:
    name: Deploy PR Preview (API + Client)
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Generate names
        id: names
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
          API_APP="speakstorelocate-api-pr-${PR_NUMBER}"
          CLIENT_APP="speakstorelocate-client-pr-${PR_NUMBER}"
          ENV_NAME="speakstorelocate-env"
          TAG="pr-${PR_NUMBER}-sha-${SHA_SHORT}"
          
          echo "api_app=$API_APP" >> $GITHUB_OUTPUT
          echo "client_app=$CLIENT_APP" >> $GITHUB_OUTPUT
          echo "env_name=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Resolve ACR login server
        id: acr
        run: |
          ACR_LOGIN_SERVER=$(az acr show \
            --name $ACR_NAME \
            --resource-group $RESOURCE_GROUP \
            --query loginServer -o tsv)
          echo "login_server=$ACR_LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: ACR Login
        run: az acr login --name $ACR_NAME

      - name: Build and push API image
        id: build-api
        run: |
          LOGIN_SERVER="${{ steps.acr.outputs.login_server }}"
          TAG="${{ steps.names.outputs.tag }}"
          API_IMAGE="$LOGIN_SERVER/speakstorelocate-apiservice:$TAG"

          docker build -f SpeakStoreLocate.ApiService/dockerfile -t $API_IMAGE .
          docker push $API_IMAGE

          echo "image=$API_IMAGE" >> $GITHUB_OUTPUT

      - name: Build and push Client image
        id: build-client
        run: |
          LOGIN_SERVER="${{ steps.acr.outputs.login_server }}"
          TAG="${{ steps.names.outputs.tag }}"
          CLIENT_IMAGE="$LOGIN_SERVER/speakstorelocate-client:$TAG"

          docker build -f SpeakStoreLocate.Client/dockerfile -t $CLIENT_IMAGE .
          docker push $CLIENT_IMAGE

          echo "image=$CLIENT_IMAGE" >> $GITHUB_OUTPUT

      - name: Create or update Container App Environment
        run: |
          ENV_NAME="${{ steps.names.outputs.env_name }}"
          
          if ! az containerapp env show -n $ENV_NAME -g $RESOURCE_GROUP 2>/dev/null; then
            az containerapp env create \
              -n $ENV_NAME \
              -g $RESOURCE_GROUP \
              -l $LOCATION
          fi

      - name: Create or update API Container App
        env:
          AWS_S3_BUCKETNAME: ${{ secrets.AWS_S3_BUCKETNAME }}
          AWS_S3_ACCESSKEY: ${{ secrets.AWS_S3_ACCESSKEY }}
          AWS_S3_SECRETKEY: ${{ secrets.AWS_S3_SECRETKEY }}
          AWS_DYNAMODB_TABLENAME: ${{ secrets.AWS_DYNAMODB_TABLENAME }}
          AWS_DYNAMODB_ACCESSKEY: ${{ secrets.AWS_DYNAMODB_ACCESSKEY }}
          AWS_DYNAMODB_SECRETKEY: ${{ secrets.AWS_DYNAMODB_SECRETKEY }}
          AWS_TRANSCRIBE_ACCESSKEY: ${{ secrets.AWS_TRANSCRIBE_ACCESSKEY }}
          AWS_TRANSCRIBE_SECRETKEY: ${{ secrets.AWS_TRANSCRIBE_SECRETKEY }}
          DEEPGRAM_APIKEY: ${{ secrets.DEEPGRAM_APIKEY }}
          ELEVENLABS_APIKEY: ${{ secrets.ELEVENLABS_APIKEY }}
          OPENAI_APIKEY: ${{ secrets.OPENAI_APIKEY }}
          OPENAI_DEFAULTMODEL: ${{ secrets.OPENAI_DEFAULTMODEL }}
        run: |
          API_APP="${{ steps.names.outputs.api_app }}"
          API_IMAGE="${{ steps.build-api.outputs.image }}"
          ENV_NAME="${{ steps.names.outputs.env_name }}"
          LOGIN_SERVER="${{ steps.acr.outputs.login_server }}"

          # Store secrets in the Container App and reference them via secretref:...
          # (So values never show up as plain env-vars in ARM state)
          API_SECRETS=(
            aws-s3-bucketname="$AWS_S3_BUCKETNAME"
            aws-s3-accesskey="$AWS_S3_ACCESSKEY"
            aws-s3-secretkey="$AWS_S3_SECRETKEY"
            aws-dynamodb-tablename="$AWS_DYNAMODB_TABLENAME"
            aws-dynamodb-accesskey="$AWS_DYNAMODB_ACCESSKEY"
            aws-dynamodb-secretkey="$AWS_DYNAMODB_SECRETKEY"
            aws-transcribe-accesskey="$AWS_TRANSCRIBE_ACCESSKEY"
            aws-transcribe-secretkey="$AWS_TRANSCRIBE_SECRETKEY"
            deepgram-apikey="$DEEPGRAM_APIKEY"
            elevenlabs-apikey="$ELEVENLABS_APIKEY"
            openai-apikey="$OPENAI_APIKEY"
            openai-defaultmodel="$OPENAI_DEFAULTMODEL"
          )

          API_ENV_VARS=(
            ASPNETCORE_ENVIRONMENT=Development
            AWS__S3__BucketName=secretref:aws-s3-bucketname
            AWS__S3__AccessKey=secretref:aws-s3-accesskey
            AWS__S3__SecretKey=secretref:aws-s3-secretkey
            AWS__DynamoDB__TableName=secretref:aws-dynamodb-tablename
            AWS__DynamoDB__AccessKey=secretref:aws-dynamodb-accesskey
            AWS__DynamoDB__SecretKey=secretref:aws-dynamodb-secretkey
            AWS__Transcribe__AccessKey=secretref:aws-transcribe-accesskey
            AWS__Transcribe__SecretKey=secretref:aws-transcribe-secretkey
            Deepgram__ApiKey=secretref:deepgram-apikey
            ElevenLabs__ApiKey=secretref:elevenlabs-apikey
            OpenAI__ApiKey=secretref:openai-apikey
            OpenAI__DefaultModel=secretref:openai-defaultmodel
          )

          if [ -z "$ACR_PULL_IDENTITY_RESOURCE_ID" ]; then
            echo "AZURE_ACR_PULL_IDENTITY_RESOURCE_ID is not set. Configure it in GitHub: Settings â†’ Secrets and variables â†’ Actions â†’ Variables (or Secrets)."
            exit 1
          fi

          if az containerapp show -n $API_APP -g $RESOURCE_GROUP 2>/dev/null; then
            az containerapp secret set \
              -n $API_APP \
              -g $RESOURCE_GROUP \
              --secrets "${API_SECRETS[@]}"

            az containerapp identity assign \
              -n $API_APP \
              -g $RESOURCE_GROUP \
              --user-assigned "$ACR_PULL_IDENTITY_RESOURCE_ID" \
              -o none

            az containerapp registry set \
              -n $API_APP \
              -g $RESOURCE_GROUP \
              --server "$LOGIN_SERVER" \
              --identity "$ACR_PULL_IDENTITY_RESOURCE_ID" \
              -o none

            az containerapp update \
              -n $API_APP \
              -g $RESOURCE_GROUP \
              --image $API_IMAGE \
              --set-env-vars "${API_ENV_VARS[@]}"

            REV=$(az containerapp show -n $API_APP -g $RESOURCE_GROUP --query properties.latestRevisionName -o tsv)
            az containerapp revision restart -n $API_APP -g $RESOURCE_GROUP --revision $REV -o none
          else
            az containerapp create \
              -n $API_APP \
              -g $RESOURCE_GROUP \
              --environment $ENV_NAME \
              --image $API_IMAGE \
              --registry-server "$LOGIN_SERVER" \
              --registry-identity "$ACR_PULL_IDENTITY_RESOURCE_ID" \
              --target-port 8080 \
              --ingress external \
              --secrets "${API_SECRETS[@]}" \
              --env-vars "${API_ENV_VARS[@]}" \
              --min-replicas 0 \
              --max-replicas 1
          fi

      - name: Get API FQDN
        id: api-url
        run: |
          API_APP="${{ steps.names.outputs.api_app }}"
          API_FQDN=$(az containerapp show \
            -n "$API_APP" \
            -g $RESOURCE_GROUP \
            --query properties.configuration.ingress.fqdn -o tsv)
          API_URL="https://$API_FQDN"
          echo "url=$API_URL" >> $GITHUB_OUTPUT

      - name: Create or update Client Container App
        run: |
          CLIENT_APP="${{ steps.names.outputs.client_app }}"
          CLIENT_IMAGE="${{ steps.build-client.outputs.image }}"
          ENV_NAME="${{ steps.names.outputs.env_name }}"
          API_URL="${{ steps.api-url.outputs.url }}"
          LOGIN_SERVER="${{ steps.acr.outputs.login_server }}"

          if [ -z "$ACR_PULL_IDENTITY_RESOURCE_ID" ]; then
            echo "AZURE_ACR_PULL_IDENTITY_RESOURCE_ID is not set. Configure it in GitHub: Settings â†’ Secrets and variables â†’ Actions â†’ Variables (or Secrets)."
            exit 1
          fi

          if az containerapp show -n $CLIENT_APP -g $RESOURCE_GROUP 2>/dev/null; then
            az containerapp identity assign \
              -n $CLIENT_APP \
              -g $RESOURCE_GROUP \
              --user-assigned "$ACR_PULL_IDENTITY_RESOURCE_ID" \
              -o none

            az containerapp registry set \
              -n $CLIENT_APP \
              -g $RESOURCE_GROUP \
              --server "$LOGIN_SERVER" \
              --identity "$ACR_PULL_IDENTITY_RESOURCE_ID" \
              -o none

            az containerapp update \
              -n $CLIENT_APP \
              -g $RESOURCE_GROUP \
              --image $CLIENT_IMAGE \
              --set-env-vars API_BASE="$API_URL/api/storage"

            REV=$(az containerapp show -n $CLIENT_APP -g $RESOURCE_GROUP --query properties.latestRevisionName -o tsv)
            az containerapp revision restart -n $CLIENT_APP -g $RESOURCE_GROUP --revision $REV -o none
          else
            az containerapp create \
              -n $CLIENT_APP \
              -g $RESOURCE_GROUP \
              --environment $ENV_NAME \
              --image $CLIENT_IMAGE \
              --registry-server "$LOGIN_SERVER" \
              --registry-identity "$ACR_PULL_IDENTITY_RESOURCE_ID" \
              --target-port 80 \
              --ingress external \
              --env-vars API_BASE="$API_URL/api/storage" \
              --min-replicas 0 \
              --max-replicas 1
          fi

      - name: Get Client FQDN
        id: client-url
        run: |
          CLIENT_APP="${{ steps.names.outputs.client_app }}"
          CLIENT_FQDN=$(az containerapp show \
            -n "$CLIENT_APP" \
            -g $RESOURCE_GROUP \
            --query properties.configuration.ingress.fqdn -o tsv)
          CLIENT_URL="https://$CLIENT_FQDN"
          echo "url=$CLIENT_URL" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            const clientUrl = '${{ steps.client-url.outputs.url }}';
            const apiUrl = '${{ steps.api-url.outputs.url }}';

            const body = `## ðŸš€ Preview-Umgebung bereitgestellt

            ### Client
            - URL: ${clientUrl}
            - API: ${apiUrl}

            ### API
            - Base URL: ${apiUrl}
            - Swagger: ${apiUrl}/swagger

            Die Umgebung wird automatisch gelÃ¶scht, wenn der PR geschlossen wird.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body
            });

  cleanup:
    name: Cleanup PR Preview
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    permissions:
      pull-requests: write

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Delete API and Client Container Apps
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          API_APP="speakstorelocate-api-pr-${PR_NUMBER}"
          CLIENT_APP="speakstorelocate-client-pr-${PR_NUMBER}"
          
          az containerapp delete -n $API_APP -g $RESOURCE_GROUP --yes || true
          az containerapp delete -n $CLIENT_APP -g $RESOURCE_GROUP --yes || true

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body: '## ðŸ§¹ Preview-Umgebung bereinigt\nAPI und Client wurden gelÃ¶scht.'
            });
