<div class="audio-recorder-container">
  <!-- Upload Status Panel -->
  @if (pendingUploadsActive.length > 0) {
    <div class="upload-status-panel">
      <mat-card class="status-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>cloud_upload</mat-icon>
            Ausstehende Uploads ({{pendingUploadsActive.length}})
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="upload-list">
            @for (upload of pendingUploadsActive; track upload.id) {
              <div class="upload-item">
                <div class="upload-info">
                  <span class="duration">{{formatDuration(upload.duration)}}</span>
                  @if (upload.isUploading) {
                    <mat-progress-spinner
                      mode="indeterminate"
                      diameter="20">
                    </mat-progress-spinner>
                  }
                </div>
                <div class="upload-actions">
                  <button
                    mat-icon-button
                    [color]="currentlyPlaying === upload.id ? 'accent' : 'primary'"
                    (click)="playAudio(upload)"
                    [disabled]="upload.isUploading">
                    <mat-icon>{{currentlyPlaying === upload.id ? 'stop' : 'play_arrow'}}</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="primary"
                    (click)="retryUpload(upload)"
                    [disabled]="upload.isUploading"
                    matTooltip="Erneut versuchen">
                    <mat-icon>refresh</mat-icon>
                  </button>
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="removeUpload(upload)"
                    [disabled]="upload.isUploading"
                    matTooltip="Entfernen">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  }

  <!-- Recording Controls -->
  <div class="recording-section">
    <mat-card class="control-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>mic</mat-icon>
          Audio Aufnahme
        </mat-card-title>
        <mat-card-subtitle>Taste gedrückt halten zum Aufnehmen</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="recording-controls">
          <button
            mat-fab
            [color]="isRecording ? 'warn' : 'primary'"
            class="record-button"
            (pointerdown)="onPointerDown($event)"
            (pointerup)="onPointerUp($event)"
            (pointercancel)="onPointerCancel($event)">
            <mat-icon>{{isRecording ? 'stop' : 'mic'}}</mat-icon>
          </button>
          @if (isRecording) {
            <div class="recording-status">
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              <span>Aufnahme läuft...</span>
            </div>
          }
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Results Table -->
  <div class="table-section">
    <mat-card>
      <mat-card-header>
        <div class="table-header-grid">
          <div class="cell icon" aria-hidden="true">
            <mat-icon>list</mat-icon>
          </div>
          <div class="cell title">
            Gespeicherte Aufnahmen
          </div>
          <div class="cell actions">
            <button mat-icon-button (click)="toggleFilters()" [color]="showFilters ? 'accent' : undefined" matTooltip="Filter anzeigen/ausblenden">
              <mat-icon>{{ showFilters ? 'filter_alt' : 'filter_alt_off' }}</mat-icon>
            </button>
          </div>
        </div>
      </mat-card-header>
      <mat-card-content>
        @if (showFilters) {
          <div class="table-toolbar" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:center; margin-bottom:12px;">
            <mat-form-field appearance="outline">
              <mat-label>Filter Ort</mat-label>
              <input matInput [formControl]="filterLocationControl" placeholder="z.B. Küche">
              @if (filterLocationControl.value) {
                <button matSuffix mat-icon-button aria-label="Clear" (click)="filterLocationControl.setValue('')">
                  <mat-icon>close</mat-icon>
                </button>
              }
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Filter Name</mat-label>
              <input matInput [formControl]="filterNameControl" placeholder="z.B. Schrauben">
              @if (filterNameControl.value) {
                <button matSuffix mat-icon-button aria-label="Clear" (click)="filterNameControl.setValue('')">
                  <mat-icon>close</mat-icon>
                </button>
              }
            </mat-form-field>
          </div>
        }

        <table mat-table [dataSource]="dataSource" class="results-table" matSort>
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
            <td mat-cell *matCellDef="let element">
              @if (editingId === element.id) {
                <mat-form-field appearance="outline" style="width: 100%;">
                  <input matInput placeholder="Name" [(ngModel)]="editName">
                </mat-form-field>
              } @else {
                {{element.name}}
              }
            </td>
          </ng-container>
          <ng-container matColumnDef="location">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Ort</th>
            <td mat-cell *matCellDef="let element">
              @if (editingId === element.id) {
                <mat-form-field appearance="outline" style="width: 100%;">
                  <input matInput placeholder="Ort" [(ngModel)]="editLocation">
                </mat-form-field>
              } @else {
                {{element.location}}
              }
            </td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Aktionen</th>
            <td mat-cell *matCellDef="let element">
              @if (editingId === element.id) {
                <button mat-icon-button color="primary" (click)="saveEdit(element)" matTooltip="Speichern">
                  <mat-icon>check</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="cancelEdit()" matTooltip="Abbrechen">
                  <mat-icon>close</mat-icon>
                </button>
              } @else {
                <button mat-icon-button color="primary" (click)="startEdit(element)" matTooltip="Bearbeiten">
                  <mat-icon>edit</mat-icon>
                </button>
              }
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Success/Error Popup -->
  @if (showPopup) {
    <div class="popup-overlay">
      <mat-card [class]="isSuccess ? 'success-popup' : 'error-popup'">
        <mat-card-content>
          <div class="popup-content">
            <mat-icon>{{isSuccess ? 'check_circle' : 'error'}}</mat-icon>
            <span>{{popupMessage}}</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  }

  <!-- Archived uploads counter (page end) -->
  <div style="margin-top: 10px; opacity: 0.8; font-size: 12px; text-align: center;">
      <div class="archive-footer" *ngIf="(flags.showArchivedUploadsUi$ | async)">
        <div>Archivierte Uploads: {{ archivedUploadsCount }}</div>

        <div class="archive-actions" *ngIf="archivedUploadsCount > 0">
          <button mat-stroked-button color="warn" (click)="clearArchivedUploads()">
            Alle archivierten Uploads löschen
          </button>

          <button mat-stroked-button (click)="requeueArchivedUploads()" *ngIf="(flags.enableArchivedRequeue$ | async)">
            Archivierte Uploads in die Queue holen
          </button>

          <button mat-stroked-button (click)="downloadArchivedUploads()" *ngIf="(flags.enableArchivedDownloads$ | async)">
            Archivierte Uploads herunterladen (ZIP)
          </button>
        </div>
      </div>
  </div>
</div>