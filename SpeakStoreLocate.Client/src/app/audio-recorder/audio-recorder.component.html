<div class="audio-recorder-container">
  <!-- Upload Status Panel -->
  <div class="upload-status-panel" *ngIf="pendingUploadsActive.length > 0">
    <mat-card class="status-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>cloud_upload</mat-icon>
          Ausstehende Uploads ({{pendingUploadsActive.length}})
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="upload-list">
          <div class="upload-item" *ngFor="let upload of pendingUploadsActive">
            <div class="upload-info">
              <span class="duration">{{formatDuration(upload.duration)}}</span>
              <mat-progress-spinner
                *ngIf="upload.isUploading"
                mode="indeterminate"
                diameter="20">
              </mat-progress-spinner>
            </div>
            <div class="upload-actions">
              <button
                mat-icon-button
                [color]="currentlyPlaying === upload.id ? 'accent' : 'primary'"
                (click)="playAudio(upload)"
                [disabled]="upload.isUploading">
                <mat-icon>{{currentlyPlaying === upload.id ? 'stop' : 'play_arrow'}}</mat-icon>
              </button>
              <button
                mat-icon-button
                color="primary"
                (click)="retryUpload(upload)"
                [disabled]="upload.isUploading"
                matTooltip="Erneut versuchen">
                <mat-icon>refresh</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="removeUpload(upload)"
                [disabled]="upload.isUploading"
                matTooltip="Entfernen">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Recording Controls -->
  <div class="recording-section">
    <mat-card class="control-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>mic</mat-icon>
          Audio Aufnahme
        </mat-card-title>
        <mat-card-subtitle>Taste gedrückt halten zum Aufnehmen</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="recording-controls">
          <button
            mat-fab
            [color]="isRecording ? 'warn' : 'primary'"
            class="record-button"
            (pointerdown)="onPointerDown($event)"
            (pointerup)="onPointerUp($event)"
            (pointercancel)="onPointerCancel($event)"
            (mousedown)="onMouseDown($event)"
            (mouseup)="onMouseUp($event)"
            (mouseleave)="onMouseLeave($event)">
            <mat-icon>{{isRecording ? 'stop' : 'mic'}}</mat-icon>
          </button>
          <div class="recording-status" *ngIf="isRecording">
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            <span>Aufnahme läuft...</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Results Table -->
  <div class="table-section">
    <mat-card>
      <mat-card-header>
        <div class="table-header-grid">
          <div class="cell icon" aria-hidden="true">
            <mat-icon>list</mat-icon>
          </div>
          <div class="cell title">
            Gespeicherte Aufnahmen
          </div>
          <div class="cell actions">
            <button mat-icon-button (click)="toggleFilters()" [color]="showFilters ? 'accent' : undefined" matTooltip="Filter anzeigen/ausblenden">
              <mat-icon>{{ showFilters ? 'filter_alt' : 'filter_alt_off' }}</mat-icon>
            </button>
          </div>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div *ngIf="showFilters" class="table-toolbar" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:center; margin-bottom:12px;">
          <mat-form-field appearance="outline">
            <mat-label>Filter Ort</mat-label>
            <input matInput [formControl]="filterLocationControl" placeholder="z.B. Küche">
            <button *ngIf="filterLocationControl.value" matSuffix mat-icon-button aria-label="Clear" (click)="filterLocationControl.setValue('')">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Filter Name</mat-label>
            <input matInput [formControl]="filterNameControl" placeholder="z.B. Schrauben">
            <button *ngIf="filterNameControl.value" matSuffix mat-icon-button aria-label="Clear" (click)="filterNameControl.setValue('')">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </div>

        <table mat-table [dataSource]="dataSource" class="results-table" matSort>
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="editingId === element.id; else viewName">
                <mat-form-field appearance="outline" style="width: 100%;">
                  <input matInput placeholder="Name" [(ngModel)]="editName">
                </mat-form-field>
              </ng-container>
              <ng-template #viewName>{{element.name}}</ng-template>
            </td>
          </ng-container>
          <ng-container matColumnDef="location">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Ort</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="editingId === element.id; else viewLocation">
                <mat-form-field appearance="outline" style="width: 100%;">
                  <input matInput placeholder="Ort" [(ngModel)]="editLocation">
                </mat-form-field>
              </ng-container>
              <ng-template #viewLocation>{{element.location}}</ng-template>
            </td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Aktionen</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="editingId === element.id; else editButton">
                <button mat-icon-button color="primary" (click)="saveEdit(element)" matTooltip="Speichern">
                  <mat-icon>check</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="cancelEdit()" matTooltip="Abbrechen">
                  <mat-icon>close</mat-icon>
                </button>
              </ng-container>
              <ng-template #editButton>
                <button mat-icon-button color="primary" (click)="startEdit(element)" matTooltip="Bearbeiten">
                  <mat-icon>edit</mat-icon>
                </button>
              </ng-template>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Success/Error Popup -->
  <div class="popup-overlay" *ngIf="showPopup">
    <mat-card [class]="isSuccess ? 'success-popup' : 'error-popup'">
      <mat-card-content>
        <div class="popup-content">
          <mat-icon>{{isSuccess ? 'check_circle' : 'error'}}</mat-icon>
          <span>{{popupMessage}}</span>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>